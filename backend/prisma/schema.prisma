// Prisma Schema for PKNU-Fest

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User model - 사용자 (학생, 운영진, 푸드트럭 운영자)
model User {
  id                String   @id @default(uuid())
  email             String   @unique
  password          String
  name              String
  phone             String
  role              UserRole @default(USER)
  isStudentVerified Boolean  @default(false) // 학생 인증 여부
  studentEmail      String?  @unique // 인증한 학교 이메일
  verified          Boolean  @default(false)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  reservations Reservation[]
  foodTruck    FoodTruck?
  orders       Order[]

  @@map("users")
}

enum UserRole {
  USER   // 일반 사용자
  ADMIN  // 운영진
  VENDOR // 푸드트럭 운영자
}

// Event model - 행사/프로그램
model Event {
  id            String      @id @default(uuid())
  title         String
  description   String?
  category      String // 게임, 먹거리, 체험 등
  location      String
  latitude      Float
  longitude     Float
  thumbnail     String?
  images        String[] // 상세 이미지 (최대 5장)
  isStudentOnly Boolean     @default(false) // 학생 전용 여부
  capacity      Int? // 인원 제한 (null이면 제한 없음)
  status        EventStatus @default(DRAFT)
  organizer     String? // 주최 단체
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  // Relations
  reservations Reservation[]
  timeSlots    TimeSlot[]

  @@map("events")
}

enum EventStatus {
  DRAFT     // 대기 (등록 완료, 아직 공개 안됨)
  PUBLISHED // 공개 (참여자에게 노출)
  FULL      // 예약 마감 (정원 도달)
  ONGOING   // 진행 중
  ENDED     // 종료
}

// TimeSlot model - 시간대별 예약
model TimeSlot {
  id        String   @id @default(uuid())
  eventId   String
  startTime DateTime
  endTime   DateTime
  capacity  Int? // 인원 제한 (null이면 제한 없음)
  reserved  Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  event        Event         @relation(fields: [eventId], references: [id], onDelete: Cascade)
  reservations Reservation[]

  @@map("time_slots")
}

// Reservation model - 예약
model Reservation {
  id          String            @id @default(uuid())
  userId      String
  eventId     String
  timeSlotId  String?
  partySize   Int? // 참여 인원 (인원 제한 있을 경우)
  status      ReservationStatus @default(CONFIRMED)
  qrCode      String            @unique
  checkedInAt DateTime? // 체크인 시간
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  // Relations
  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  event    Event     @relation(fields: [eventId], references: [id], onDelete: Cascade)
  timeSlot TimeSlot? @relation(fields: [timeSlotId], references: [id], onDelete: SetNull)

  @@map("reservations")
}

enum ReservationStatus {
  CONFIRMED  // 확정
  CHECKED_IN // 체크인 완료
  NO_SHOW    // 노쇼
  CANCELLED  // 취소
}

// FoodTruck model - 푸드트럭
model FoodTruck {
  id          String   @id @default(uuid())
  name        String
  description String?
  location    String
  latitude    Float
  longitude   Float
  ownerId     String   @unique
  imageUrl    String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  owner User       @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  menu  MenuItem[]
  orders Order[]

  @@map("food_trucks")
}

// MenuItem model - 메뉴
model MenuItem {
  id          String   @id @default(uuid())
  foodTruckId String
  name        String
  description String?
  price       Int
  imageUrl    String?
  available   Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  foodTruck  FoodTruck   @relation(fields: [foodTruckId], references: [id], onDelete: Cascade)
  orderItems OrderItem[]

  @@map("menu_items")
}

// Order model - 주문
model Order {
  id            String        @id @default(uuid())
  userId        String
  foodTruckId   String
  status        OrderStatus   @default(PENDING)
  totalPrice    Int
  pickupNumber  String?
  paymentId     String?       // 결제 ID (모의 결제에서는 UUID)
  paymentMethod String?       // 결제 수단 (CARD, KAKAO_PAY, TOSS_PAY)
  paymentStatus PaymentStatus @default(PENDING) // 결제 상태
  paidAt        DateTime?     // 결제 완료 시각
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  // Relations
  user       User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  foodTruck  FoodTruck   @relation(fields: [foodTruckId], references: [id], onDelete: Cascade)
  orderItems OrderItem[]

  @@map("orders")
}

enum OrderStatus {
  PENDING    // 주문 접수
  PREPARING  // 조리 중
  READY      // 준비 완료
  COMPLETED  // 수령 완료
  CANCELLED  // 취소
}

enum PaymentStatus {
  PENDING   // 결제 대기
  PAID      // 결제 완료
  CANCELLED // 결제 취소
  REFUNDED  // 환불 완료
}

// OrderItem model - 주문 아이템
model OrderItem {
  id         String   @id @default(uuid())
  orderId    String
  menuItemId String
  quantity   Int
  price      Int
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  order    Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  menuItem MenuItem @relation(fields: [menuItemId], references: [id], onDelete: Cascade)

  @@map("order_items")
}
